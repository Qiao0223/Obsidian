# 1. 主从复制
## 1.1. 原理

Redis 的主从复制过程主要包括以下三个阶段：
### 1. 建立连接

- 从节点通过发送 `SLAVEOF` 或 `REPLICAOF` 命令，指定主节点的 IP 和端口，发起复制请求。
- 主从节点之间建立 TCP 连接，并进行身份验证（如果配置了密码）。

### 2. 数据同步

数据同步分为全量复制和部分复制两种方式：

#### 全量复制

适用于初次连接或无法进行部分复制的情况。

- 主节点执行 `BGSAVE` 命令，生成 RDB 快照文件。
- 主节点将 RDB 文件发送给从节点，从节点加载该文件，完成数据同步。
- 在 RDB 文件传输期间，主节点会将新的写命令缓存在复制积压缓冲区（Replication Backlog）中。
- RDB 文件加载完成后，主节点将缓冲区中的写命令发送给从节点，确保数据一致。

#### 部分复制

适用于网络中断后重新连接的情况。

- 从节点发送 `PSYNC` 命令，附带上次复制的偏移量。
- 如果主节点的复制积压缓冲区中仍保留有从节点缺失的数据，则只需发送这部分数据，实现增量同步。
- 如果缓冲区中没有所需数据，则退回到全量复制。
### 3. 命令传播

数据同步完成后，主节点会将新的写命令实时发送给从节点，从节点执行这些命令，保持数据一致性。

## 1.2. 主从复制的作用

- **数据冗余**：提供数据的热备份，增强系统的容灾能力。
- **故障恢复**：主节点故障时，从节点可接替服务，减少系统停机时间。
- **负载均衡**：通过读写分离，主节点处理写请求，从节点处理读请求，提高系统的并发处理能力。
- **高可用基础**：主从复制是实现 Redis 哨兵模式和集群模式的基础。

## 1.3. 注意事项

- **复制延迟**：由于网络延迟和异步复制，从节点的数据可能略滞后于主节点。
- **复制积压缓冲区大小**：默认大小为 1MB，可通过 `repl-backlog-size` 参数调整，以减少全量复制的频率。
- **从节点只读**：默认情况下，从节点为只读模式，避免数据不一致。
- **主从链路**：支持级联复制，即从节点也可以作为其他从节点的主节点。