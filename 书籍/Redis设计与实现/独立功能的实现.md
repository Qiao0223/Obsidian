# 1. 事务

Redis 中的事务机制提供了一种将多个命令打包，一次性、按顺序执行的能力，从而确保在事务执行过程中，不会被其他客户端的命令请求所打断，保证了事务的隔离性。

## 1.1. Redis 事务的基本命令

Redis 事务主要依赖以下命令来实现：

- **`MULTI`**：开启事务，Redis 会将后续的命令放入队列中，而不是立即执行。
- **`EXEC`**：执行事务中的所有命令。
- **`DISCARD`**：取消事务，放弃执行事务块中的所有命令。
- **`WATCH`**：监视一个或多个键，如果在事务执行前这些键被其他命令修改，则事务被中断，不会执行事务中的任何命令。
- **`UNWATCH`**：取消对所有键的监视。

## 1.2. Redis 事务的执行流程

1. **开始事务**：使用 `MULTI` 命令标记事务的开始。
2. **命令入队**：在事务中执行的命令会被依次放入事务队列中，Redis 返回 `QUEUED` 表示命令已入队。
3. **执行事务**：使用 `EXEC` 命令触发事务，Redis 会按照命令入队的顺序依次执行事务队列中的所有命令。
4. **取消事务**：在执行 `EXEC` 之前，可以使用 `DISCARD` 命令取消事务，清空事务队列。

## 1.3. Redis 事务的特性

- **原子性**：Redis 事务中的命令要么全部执行，要么全部不执行。
- **隔离性**：在事务执行过程中，其他客户端的命令不会插入到事务执行序列中。
- **顺序性**：事务中的命令按照添加的顺序依次执行。

## 1.4. Redis 事务的局限性

- **不支持回滚**：如果事务中的某个命令执行失败，Redis 不会回滚已经执行的命令。
- **错误处理**：在事务中，如果某个命令执行失败，其他命令仍会继续执行。
- **无法保证完全的隔离性**：虽然在事务执行过程中，其他客户端的命令不会插入到事务执行序列中，但在事务开始和执行期间，其他客户端的命令可能会影响到事务的结果。
## 1.5. WATCH 命令的使用

`WATCH` 命令用于实现乐观锁机制。在事务开始前，使用 `WATCH` 命令监视一个或多个键，如果在事务执行前这些键被其他命令修改，则事务被中断，不会执行事务中的任何命令。

## 1.6. Lua 脚本的使用

为了实现更强的原子性，Redis 支持使用 Lua 脚本来执行一系列命令。如果脚本中的某条命令出错，脚本会立即终止执行，后续的命令不会被执行。然而，在错误发生之前已成功执行的命令所做的修改将被保留，Redis 不会自动回滚这些更改。

