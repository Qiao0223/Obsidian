# 1. RDB
## 1.1. 原理

RDB 通过保存某一时刻的内存快照，实现数据的持久化。在 Redis 重启时，系统会自动加载 `dump.rdb` 文件中的数据，恢复到之前的状态。

## 1.2. 触发方式
#### 1. 手动触发

- **`SAVE` 命令**：在主线程中同步执行，生成 RDB 文件期间会阻塞 Redis，影响性能，通常不建议在生产环境中使用。
- **`BGSAVE` 命令**：通过 `fork()` 创建子进程异步执行快照操作，主进程仍可处理客户端请求。但在 `fork` 阶段仍会有短暂阻塞。 

#### 2. 自动触发

可在配置文件 `redis.conf` 中设置自动保存规则，例如：
```
save 900 1
save 300 10
save 60 10000
```
表示：900 秒内至少有 1 个键发生变化，或 300 秒内至少有 10 个键变化，或 60 秒内至少有 10000 个键变化时，触发 RDB 持久化。

## 1.3. RDB 文件特点

- **格式**：压缩的二进制文件，默认名为 `dump.rdb`，存储在配置的目录中。
- **恢复速度快**：直接加载快照文件即可恢复数据，效率高。
- **轻量**：文件体积小，适合备份和迁移。

## 1.4. 优点

- **高效备份**：适合定期备份，便于灾难恢复。
- **启动快速**：重启时加载速度快，适合对恢复时间有要求的场景。
- **资源占用低**：相比 AOF，RDB 对磁盘和 CPU 的压力较小。

## 1.5. 缺点 

- **数据丢失风险**：由于是定期快照，可能会丢失最后一次快照后写入的数据。
- **不适合频繁写入场景**：在高频写操作的应用中，RDB 可能无法满足实时持久化的需求。

# 2. AOF
## 2.1. 原理

- **命令追加**：每当 Redis 执行写操作（如 `SET`、`DEL` 等）时，会将该命令以 Redis 协议格式追加到 AOF 缓冲区。
- **文件写入与同步**：根据配置的策略（详见下文），将缓冲区中的命令写入 AOF 文件，并根据同步策略将数据刷新到磁盘。
- **数据恢复**：当 Redis 重启时，会读取 AOF 文件中的命令，按顺序重新执行，以恢复数据。

## 2.2. 同步策略

随着时间推移，AOF 文件会不断增大，影响性能。为此，Redis 提供 AOF 重写机制：

- **触发方式**：可以手动执行 `BGREWRITEAOF` 命令，或根据配置自动触发。
- **重写过程**：Redis 会创建一个子进程，扫描当前内存中的数据，为每个键生成最小化的写命令集合，写入新的 AOF 文件。
- **文件替换**：重写完成后，新的 AOF 文件会替换旧的文件，并将主线程缓冲区中的命令追加写入到新的AOF文件，继续记录新的写操作。

## 2.3. 优点

- **数据安全性高**：通过记录每次写操作，确保数据的持久化，丢失数据的风险较低。
- **灵活的同步策略**：可根据需求选择合适的同步策略，平衡性能与数据安全。

## 2.4. 缺点

- **性能开销**：频繁的磁盘写操作可能影响性能，尤其在同步策略为 `always` 时。
- **恢复速度较慢**：重启时需要逐条执行 AOF 文件中的命令，恢复速度比 RDB 慢。
- **文件体积大**：长期运行后，AOF 文件可能变得庞大，需定期重写。

# 3. 事件

Redis 是一个高性能的键值数据库，其核心之一是基于事件驱动的架构。这种架构主要通过自研的事件处理库 `ae_event` 实现，负责管理两类关键事件：**文件事件（File Event）** 和 **时间事件（Time Event）**。这两类事件由中央事件循环 `aeEventLoop` 协调处理。

## 3.1. 文件事件（File Event）

文件事件用于处理 Redis 与客户端之间的网络通信，涵盖连接建立、命令读取和响应发送等操作。

### 工作机制

1. **IO 多路复用**：Redis 使用 `select`、`epoll`、`kqueue` 等系统调用来监听多个套接字的事件。
2. **事件注册**：每个套接字（如客户端连接）可以注册可读（`AE_READABLE`）或可写（`AE_WRITABLE`）事件，并关联相应的处理器函数。
3. **事件分派**：当某个套接字准备好进行读写操作时，事件循环会调用相应的处理器，如：
    - **连接应答处理器**：处理新客户端连接。
    - **命令请求处理器**：读取客户端发送的命令。
    - **命令回复处理器**：将命令执行结果发送给客户端。

### 架构组成

文件事件处理器由以下四部分组成：

- **套接字**：代表客户端连接。
- **IO 多路复用程序**：监听多个套接字的事件。
- **文件事件分派器**：将就绪的事件分派给相应的处理器。
- **事件处理器**：执行具体的读写操作。

这种设计基于 Reactor 模式，使 Redis 能够在单线程中高效处理大量并发连接。

## 3.2. 时间事件（Time Event）

时间事件用于处理需要在特定时间点执行的操作，如定时任务和周期性任务。
### 类型

- **定时事件**：在指定时间后执行一次的任务。
- **周期性事件**：每隔固定时间间隔重复执行的任务。

Redis 中的时间事件主要由 `serverCron` 函数处理，该函数默认每秒执行 10 次（可通过配置项 `hz` 调整），其职责包括：

- 更新服务器统计信息（如内存使用、连接数等）。
- 处理持久化操作（如 RDB 和 AOF）。
- 关闭空闲连接。

### 数据结构

时间事件使用链表结构进行管理，每个事件包含：

- **唯一 ID**：标识事件。
- **执行时间**：以秒和毫秒为单位。
- **处理函数**：事件触发时调用的函数。
- **清理函数**：事件删除时调用的函数。

事件循环会遍历链表，查找并执行已到期的时间事件。

## 3.3. aeEventLoop：事件循环核心

`aeEventLoop` 是 Redis 的事件循环核心，负责协调文件事件和时间事件的处理。其主要工作流程如下：

1. **等待事件**：使用 IO 多路复用技术等待文件事件的发生。
2. **处理文件事件**：对就绪的文件事件调用相应的处理器。
3. **处理时间事件**：检查并执行已到期的时间事件。
4. **循环执行**：重复上述步骤，直到服务器关闭。

这种设计使 Redis 能够在单线程中高效地处理大量并发连接和定时任务，保持高性能和低延迟。

## 3.4. 总结

Redis 的事件机制通过自研的 `ae_event` 库，实现了高效的事件驱动架构。文件事件处理器基于 Reactor 模式，结合 IO 多路复用技术，使 Redis 能够在单线程中高效处理大量并发连接。时间事件机制则确保了定时任务的准确执行。整个事件处理流程由 `aeEventLoop` 协调，确保了系统的高性能和可扩展性。

